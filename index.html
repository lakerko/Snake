<!DOCTYPE html>
<html>
<head>
    <title>Snake Advanced</title>
</head>
<body>
<script src="Hole.js"></script>
<script src="Player.js"></script>
<script src="Food.js"></script>
<script src="Generator.js"></script>
<script>
    var canvas = document.createElement("canvas");
    var ctx = canvas.getContext("2d");
    canvas.width = 320;
    canvas.height = 320;
    document.body.appendChild(canvas);

    function GameDifficulty(GD) {
        //this.lineFromHole = 0;

        if (GD == "easy") {
            this.lineFromHole = 12;
            this.randomLow = 4;
            this.randomHigh = 7;
        }
    }

    var keysDown = {};
    var timing = 0;
    var eaten = false;
    var poop = [];
    var score = 0;
    var generateMap = false;
    var player = new Player();
    var food = new Food();
    var hole = new Hole();
    var gameDif = new GameDifficulty("easy");
    var spawningFromHoleX = 50;
    var spawningFromHoleY = 0;
    var alreadyRunM1 = false;
    var alreadyRunM2 = false;
    var alreadyRunMG = false;
    var holeAnimation = false;
    var antiMovementPeriod = 0;
    var animationCounter = 0;
    var aMap = [];

    addEventListener("keydown", function (e) {
        if (score > 1 && score % 10 == 1 && antiMovementPeriod < 3) {
            keysDown[e.keyCode] = false;
        } else {
            keysDown[e.keyCode] = true;
        }
    }, false);

    addEventListener("keyup", function (e) {
        delete keysDown[e.keyCode];
    }, false);

    var reset = function() {
        score = 9;
        poop = [];
        player.reset();
        food.spawn(hole);
        generateMap = false;
        alreadyRunM1 = false;
        alreadyRunM2 = false;
        alreadyRunMG = false;
    }

    var update = function(delta) {
        if (score > 2 && score % 10 == 2) {
            alreadyRunM1 = false;
        }
        if (score > 3 && score % 10 == 3) {
            alreadyRunM2 = false;
            alreadyRunMG = false;
            aMap = [];
        }

        hole.update();
        if (score > 1 && score % 10 == 0) {
            if (holeAnimation) {
                if (animationCounter == 5) {
                    score++;
                    food.spawn(hole);
                    animationCounter = 0;
                    holeAnimation = false;
                    player.aBodyAnimation = [];
                }
            } else {
                player.levelEntry(food);
            }
        } else if (score > 1 && score % 10 == 1){
            poop = [];
            player.fromHole();
            if (!alreadyRunMG) {
                mapGenerator();
            }
            if (holeAnimation) {
                if (animationCounter == 5) {
                    score++;
                    food.spawn(hole);
                    animationCounter = 0;
                    holeAnimation = false;
                    generateMap = false;
                    player.aBodyAnimation = [];
                }
            } else {
                player.levelExit(food);
            }
        } else if (score > 2 && score % 10 == 2){
            player.fromHole();
            player.catchFood(food);
            alreadyRunMG = false;
        } else {
            player.catchFood(food);
        }

        player.update(delta);
        player.bodyCollision();
        if (score > 1 && score % 10 == 1 && generateMap) {
            player.mapCollision();
        }

        if (eaten) {
            player.eatFood();
        }
    }

    var render = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle="#FF0000";
        ctx.strokeRect(0, 0, canvas.width, canvas.height);

        if (generateMap) {
            for (var i = 0; i < 32; i++) {
                for (var j = 0; j < 32; j++) {
                    if (aMap[i][j].name == "wall") {
                        ctx.fillStyle = "rgba(150, 150, 150, 1)";
                    } else if (aMap[i][j].name == "way") {
                        ctx.fillStyle = "rgba(10, 200, 10, 1)";
                    } else if (aMap[i][j].name == "hole") {
                        ctx.fillStyle = "rgba(250, 10, 10, 1)";
                    }
                    ctx.fillRect(i * 10, j * 10, 10, 10);
                }
            }
        }
        if (score > 2 && (score % 10 == 0 || score % 10 == 1)){
            hole.render();
        } else {
            food.render();
        }
        player.render();

        if (eaten) {
            ctx.fillStyle = "rgba("+(poop[0] / 2)+", "+(poop[1] / 2)+","+(poop[0] / 2)+", 0.6)";
            ctx.fillRect(poop[0], poop[1], 10, 10);
        }
        ctx.fillText("Score: "+score, canvas.width - 50, canvas.height - 10);
    }

    var main = function() {
        var now = Date.now();
        var delta = now - then;

        update(delta);
        render();

        then = now;
    }

    reset();
    var then = Date.now();
    setInterval(main, 1);
</script>
</body>
</html>